<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <meta name="referrer" content="no-referrer">
        <title>Unixå¥—æ¥å­—ç¼–ç¨‹ - Weiyee&#39;s Blog</title><meta name="Description" content="è®°å½•ä¸ªäººå­¦ä¹ çš„åšå®¢"><meta property="og:title" content="Unixå¥—æ¥å­—ç¼–ç¨‹" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://example.com/unix_socket/" /><meta property="og:image" content="https://example.com/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-04-17T21:58:29+08:00" />
<meta property="article:modified_time" content="2021-04-17T21:58:29+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://example.com/logo.png"/>

<meta name="twitter:title" content="Unixå¥—æ¥å­—ç¼–ç¨‹"/>
<meta name="twitter:description" content=""/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://example.com/unix_socket/" /><link rel="prev" href="https://example.com/cmake_tutorial/" /><link rel="next" href="https://example.com/io_multiplexing/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Unixå¥—æ¥å­—ç¼–ç¨‹",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/example.com\/unix_socket\/"
        },"image": ["https:\/\/example.com\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "Unix, Socket","wordcount":  6238 ,
        "url": "https:\/\/example.com\/unix_socket\/","datePublished": "2021-04-17T21:58:29+08:00","dateModified": "2021-04-17T21:58:29+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": "https:\/\/example.com\/images\/avatar.png"},"author": {
                "@type": "Person",
                "name": "Weiyee"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Weiyee&#39;s Blog"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>Weiyee&#39;s Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> ğŸ“” æ‰€æœ‰æ–‡ç«  </a><a class="menu-item" href="/tags/"> ğŸ·ï¸ æ ‡ç­¾ </a><a class="menu-item" href="/categories/"> ğŸ—‚ï¸ åˆ†ç±» </a><a class="menu-item" href="/about/"> ğŸ‘¨â€ğŸ’» å…³äº </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="æœç´¢">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="æ¸…ç©º">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Weiyee&#39;s Blog"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>Weiyee&#39;s Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="æœç´¢">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="æ¸…ç©º">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        å–æ¶ˆ
                    </a>
                </div><a class="menu-item" href="/posts/" title="">ğŸ“” æ‰€æœ‰æ–‡ç« </a><a class="menu-item" href="/tags/" title="">ğŸ·ï¸ æ ‡ç­¾</a><a class="menu-item" href="/categories/" title="">ğŸ—‚ï¸ åˆ†ç±»</a><a class="menu-item" href="/about/" title="">ğŸ‘¨â€ğŸ’» å…³äº</a><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">ç›®å½•</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Unixå¥—æ¥å­—ç¼–ç¨‹</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Weiyee</a></span>&nbsp;<span class="post-category">æ”¶å½•äº <a href="/categories/computer-network/"><i class="far fa-folder fa-fw"></i>Computer Network</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-04-17">2021-04-17</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;çº¦ 6238 å­—&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;é¢„è®¡é˜…è¯» 13 åˆ†é’Ÿ&nbsp;</div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i0.hdslb.com/bfs/album/df7b6d46621859c99357ddcadc6d21f5a3495eba.png"
        data-srcset="https://i0.hdslb.com/bfs/album/df7b6d46621859c99357ddcadc6d21f5a3495eba.png, https://i0.hdslb.com/bfs/album/df7b6d46621859c99357ddcadc6d21f5a3495eba.png 1.5x, https://i0.hdslb.com/bfs/album/df7b6d46621859c99357ddcadc6d21f5a3495eba.png 2x"
        data-sizes="auto"
        alt="https://i0.hdslb.com/bfs/album/df7b6d46621859c99357ddcadc6d21f5a3495eba.png"
        title="https://i0.hdslb.com/bfs/album/df7b6d46621859c99357ddcadc6d21f5a3495eba.png" /></div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>ç›®å½•</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#socketä»‹ç»">Socketä»‹ç»</a></li>
    <li><a href="#å­—èŠ‚åº">å­—èŠ‚åº</a>
      <ul>
        <li><a href="#å­—èŠ‚åºä¸¾ä¾‹">å­—èŠ‚åºä¸¾ä¾‹</a></li>
        <li><a href="#å­—èŠ‚åºè½¬æ¢">å­—èŠ‚åºè½¬æ¢</a></li>
      </ul>
    </li>
    <li><a href="#socketåœ°å€">Socketåœ°å€</a>
      <ul>
        <li><a href="#é€šç”¨socketåœ°å€">é€šç”¨Socketåœ°å€</a></li>
        <li><a href="#ä¸“ç”¨socketåœ°å€">ä¸“ç”¨Socketåœ°å€</a></li>
      </ul>
    </li>
    <li><a href="#ipåœ°å€è½¬æ¢">IPåœ°å€è½¬æ¢</a></li>
    <li><a href="#å¥—æ¥å­—å‡½æ•°">å¥—æ¥å­—å‡½æ•°</a>
      <ul>
        <li>
          <ul>
            <li><a href="#æœåŠ¡å™¨ç«¯">æœåŠ¡å™¨ç«¯</a></li>
            <li><a href="#å®¢æˆ·ç«¯">å®¢æˆ·ç«¯</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#tcpé€šä¿¡æµç¨‹">TCPé€šä¿¡æµç¨‹</a>
      <ul>
        <li><a href="#æœåŠ¡å™¨ç«¯-è¢«åŠ¨æ¥å—è¿æ¥çš„è§’è‰²">æœåŠ¡å™¨ç«¯ ï¼ˆè¢«åŠ¨æ¥å—è¿æ¥çš„è§’è‰²ï¼‰</a></li>
        <li><a href="#å®¢æˆ·ç«¯-1">å®¢æˆ·ç«¯</a></li>
        <li><a href="#å¤šè¿›ç¨‹tcpé€šä¿¡">å¤šè¿›ç¨‹TCPé€šä¿¡</a>
          <ul>
            <li><a href="#æœåŠ¡ç«¯">æœåŠ¡ç«¯</a></li>
            <li><a href="#å®¢æˆ·ç«¯-2">å®¢æˆ·ç«¯</a></li>
          </ul>
        </li>
        <li><a href="#å¤šçº¿ç¨‹tcpé€šä¿¡">å¤šçº¿ç¨‹TCPé€šä¿¡</a>
          <ul>
            <li><a href="#æœåŠ¡ç«¯-1">æœåŠ¡ç«¯</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#udpé€šä¿¡æµç¨‹">UDPé€šä¿¡æµç¨‹</a>
      <ul>
        <li><a href="#æœåŠ¡ç«¯-2">æœåŠ¡ç«¯</a></li>
        <li><a href="#å®¢æˆ·ç«¯-3">å®¢æˆ·ç«¯</a></li>
      </ul>
    </li>
    <li><a href="#å‚è€ƒ">å‚è€ƒ</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="socketä»‹ç»">Socketä»‹ç»</h2>
<p>æ‰€è°“ <code>socket</code>ï¼ˆå¥—æ¥å­—ï¼‰ï¼Œå°±æ˜¯å¯¹ç½‘ç»œä¸­ä¸åŒä¸»æœºä¸Šçš„åº”ç”¨è¿›ç¨‹ä¹‹é—´è¿›è¡ŒåŒå‘é€šä¿¡çš„ç«¯ç‚¹çš„æŠ½è±¡ã€‚ä¸€ä¸ªå¥—æ¥å­—å°±æ˜¯ç½‘ç»œä¸Šè¿›ç¨‹é€šä¿¡çš„ä¸€ç«¯ï¼Œæä¾›äº†åº”ç”¨å±‚è¿›ç¨‹åˆ©ç”¨ç½‘ç»œåè®®äº¤æ¢æ•°æ®çš„æœºåˆ¶ã€‚ä»æ‰€å¤„çš„åœ°ä½æ¥è®²ï¼Œå¥—æ¥å­—ä¸Šè”åº”ç”¨è¿›ç¨‹ï¼Œä¸‹è”ç½‘ç»œåè®®æ ˆï¼Œæ˜¯åº”ç”¨ç¨‹åºé€šè¿‡ç½‘ç»œåè®®è¿›è¡Œé€šä¿¡çš„æ¥å£ï¼Œæ˜¯åº”ç”¨ç¨‹åºä¸ç½‘ç»œåè®®æ ¹è¿›è¡Œäº¤äº’çš„æ¥å£ã€‚</p>
<p>socket å¯ä»¥çœ‹æˆæ˜¯ä¸¤ä¸ªç½‘ç»œåº”ç”¨ç¨‹åºè¿›è¡Œé€šä¿¡æ—¶ï¼Œå„è‡ªé€šä¿¡è¿æ¥ä¸­çš„ç«¯ç‚¹ï¼Œè¿™æ˜¯ä¸€ä¸ªé€»è¾‘ä¸Šçš„æ¦‚å¿µã€‚å®ƒæ˜¯ç½‘ç»œç¯å¢ƒä¸­è¿›ç¨‹é—´é€šä¿¡çš„ APIï¼Œä¹Ÿæ˜¯å¯ä»¥è¢«å‘½åå’Œå¯»å€çš„é€šä¿¡ç«¯ç‚¹ï¼Œä½¿ç”¨ä¸­çš„æ¯ä¸€ä¸ªå¥—æ¥å­—éƒ½æœ‰å…¶ç±»å‹å’Œä¸€ä¸ªä¸ä¹‹ç›¸è¿è¿›ç¨‹ã€‚é€šä¿¡æ—¶å…¶ä¸­ä¸€ä¸ªç½‘ç»œåº”ç”¨ç¨‹åºå°†è¦ä¼ è¾“çš„ä¸€æ®µä¿¡æ¯å†™å…¥å®ƒæ‰€åœ¨ä¸»æœºçš„ socket ä¸­ï¼Œè¯¥ socket é€šè¿‡ä¸ç½‘ç»œæ¥å£å¡ï¼ˆNICï¼‰ç›¸è¿çš„ä¼ è¾“ä»‹è´¨å°†è¿™æ®µä¿¡æ¯é€åˆ°å¦å¤–ä¸€å°ä¸»æœºçš„ socket ä¸­ï¼Œä½¿å¯¹æ–¹èƒ½å¤Ÿæ¥æ”¶åˆ°è¿™æ®µä¿¡æ¯ã€‚socket æ˜¯ç”± IP åœ°å€å’Œç«¯å£ç»“åˆçš„ï¼Œæä¾›å‘åº”ç”¨å±‚è¿›ç¨‹ä¼ é€æ•°æ®åŒ…çš„æœºåˆ¶ã€‚</p>
<p>socket æœ¬èº«æœ‰â€œæ’åº§â€çš„æ„æ€ï¼Œåœ¨ Linux ç¯å¢ƒä¸‹ï¼Œç”¨äºè¡¨ç¤º<strong>è¿›ç¨‹é—´ç½‘ç»œé€šä¿¡çš„ç‰¹æ®Šæ–‡ä»¶ç±»å‹</strong>ã€‚æœ¬è´¨ä¸ºå†…æ ¸å€ŸåŠ©ç¼“å†²åŒºå½¢æˆçš„ä¼ªæ–‡ä»¶ã€‚æ—¢ç„¶æ˜¯æ–‡ä»¶ï¼Œé‚£ä¹ˆç†æ‰€å½“ç„¶çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ–‡ä»¶æè¿°ç¬¦å¼•ç”¨å¥—æ¥å­—ã€‚ä¸ç®¡é“ç±»ä¼¼çš„ï¼ŒLinux ç³»ç»Ÿå°†å…¶å°è£…æˆæ–‡ä»¶çš„ç›®çš„æ˜¯ä¸ºäº†ç»Ÿä¸€æ¥å£ï¼Œä½¿å¾—è¯»å†™å¥—æ¥å­—å’Œè¯»å†™æ–‡ä»¶çš„æ“ä½œä¸€è‡´ã€‚åŒºåˆ«æ˜¯ç®¡é“ä¸»è¦åº”ç”¨äºæœ¬åœ°è¿›ç¨‹é—´é€šä¿¡ï¼Œè€Œå¥—æ¥å­—å¤šåº”ç”¨äºç½‘ç»œè¿›ç¨‹é—´æ•°æ®çš„ä¼ é€’ã€‚</p>
<h2 id="å­—èŠ‚åº">å­—èŠ‚åº</h2>
<p>ç°ä»£ CPU çš„ç´¯åŠ å™¨ä¸€æ¬¡éƒ½èƒ½è£…è½½ï¼ˆè‡³å°‘ï¼‰4 å­—èŠ‚ï¼ˆè¿™é‡Œè€ƒè™‘ 32 ä½æœºï¼‰ï¼Œå³ä¸€ä¸ªæ•´æ•°ã€‚é‚£ä¹ˆè¿™ 4  å­—èŠ‚åœ¨å†…å­˜ä¸­æ’åˆ—çš„é¡ºåºå°†å½±å“å®ƒè¢«ç´¯åŠ å™¨è£…è½½æˆçš„æ•´æ•°çš„å€¼ï¼Œè¿™å°±æ˜¯å­—èŠ‚åºé—®é¢˜ã€‚åœ¨å„ç§è®¡ç®—æœºä½“ç³»ç»“æ„ä¸­ï¼Œå¯¹äºå­—èŠ‚ã€å­—ç­‰çš„å­˜å‚¨æœºåˆ¶æœ‰æ‰€ä¸åŒï¼Œå› è€Œå¼•å‘äº†è®¡ç®—æœºé€šä¿¡é¢†åŸŸä¸­ä¸€ä¸ªå¾ˆé‡è¦çš„é—®é¢˜ï¼Œå³é€šä¿¡åŒæ–¹äº¤æµçš„ä¿¡æ¯å•å…ƒï¼ˆæ¯”ç‰¹ã€å­—èŠ‚ã€å­—ã€åŒå­—ç­‰ç­‰ï¼‰åº”è¯¥ä»¥ä»€ä¹ˆæ ·çš„é¡ºåºè¿›è¡Œä¼ é€ã€‚å¦‚æœä¸è¾¾æˆä¸€è‡´çš„è§„åˆ™ï¼Œé€šä¿¡åŒæ–¹å°†æ— æ³•è¿›è¡Œæ­£ç¡®çš„ç¼–ç /è¯‘ç ä»è€Œå¯¼è‡´é€šä¿¡å¤±è´¥ã€‚</p>
<p><strong>å­—èŠ‚åºï¼Œé¡¾åæ€ä¹‰å­—èŠ‚çš„é¡ºåºï¼Œå°±æ˜¯å¤§äºä¸€ä¸ªå­—èŠ‚ç±»å‹çš„æ•°æ®åœ¨å†…å­˜ä¸­çš„å­˜æ”¾é¡ºåº(ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®å½“ç„¶å°±æ— éœ€è°ˆé¡ºåºçš„é—®é¢˜äº†)</strong>ã€‚</p>
<p>å­—èŠ‚åºåˆ†ä¸º<strong>å¤§ç«¯å­—èŠ‚åº</strong>ï¼ˆBig-Endianï¼‰ å’Œ<strong>å°ç«¯å­—èŠ‚åº</strong>ï¼ˆLittle-Endianï¼‰ã€‚å¤§ç«¯å­—èŠ‚åºæ˜¯æŒ‡ä¸€ä¸ªæ•´æ•°çš„æœ€é«˜ä½å­—èŠ‚ï¼ˆ23 ~ 31 bitï¼‰å­˜å‚¨åœ¨å†…å­˜çš„ä½åœ°å€å¤„ï¼Œä½ä½å­—èŠ‚ï¼ˆ0 ~ 7 bitï¼‰å­˜å‚¨åœ¨å†…å­˜çš„é«˜åœ°å€å¤„ï¼›å°ç«¯å­—èŠ‚åºåˆ™æ˜¯æŒ‡æ•´æ•°çš„é«˜ä½å­—èŠ‚å­˜å‚¨åœ¨å†…å­˜çš„é«˜åœ°å€å¤„ï¼Œè€Œä½ä½å­—èŠ‚åˆ™å­˜å‚¨åœ¨å†…å­˜çš„ä½åœ°å€å¤„ã€‚</p>
<h3 id="å­—èŠ‚åºä¸¾ä¾‹">å­—èŠ‚åºä¸¾ä¾‹</h3>
<img src="https://i0.hdslb.com/bfs/album/01105be36c5929338ea0abd63f996be07cdc2aa2.png" title="" alt="" data-align="center">
<h3 id="å­—èŠ‚åºè½¬æ¢">å­—èŠ‚åºè½¬æ¢</h3>
<p>å½“æ ¼å¼åŒ–çš„æ•°æ®åœ¨ä¸¤å°ä½¿ç”¨ä¸åŒå­—èŠ‚åºçš„ä¸»æœºä¹‹é—´ç›´æ¥ä¼ é€’æ—¶ï¼Œæ¥æ”¶ç«¯å¿…ç„¶é”™è¯¯çš„è§£é‡Šä¹‹ã€‚è§£å†³é—®é¢˜çš„æ–¹æ³•æ˜¯ï¼š<strong>å‘é€ç«¯æ€»æ˜¯æŠŠè¦å‘é€çš„æ•°æ®è½¬æ¢æˆå¤§ç«¯å­—èŠ‚åºæ•°æ®åå†å‘é€ï¼Œè€Œæ¥æ”¶ç«¯çŸ¥é“å¯¹æ–¹ä¼ é€è¿‡æ¥çš„æ•°æ®æ€»æ˜¯é‡‡ç”¨å¤§ç«¯å­—èŠ‚åºï¼Œæ‰€ä»¥æ¥æ”¶ç«¯å¯ä»¥æ ¹æ®è‡ªèº«é‡‡ç”¨çš„å­—èŠ‚åºå†³å®šæ˜¯å¦å¯¹æ¥æ”¶åˆ°çš„æ•°æ®è¿›è¡Œè½¬æ¢</strong>ï¼ˆå°ç«¯æœºè½¬æ¢ï¼Œå¤§ç«¯æœºä¸è½¬æ¢ï¼‰</p>
<p>ç½‘ç»œå­—èŠ‚é¡ºåºæ˜¯ TCP/IP ä¸­è§„å®šå¥½çš„ä¸€ç§æ•°æ®è¡¨ç¤ºæ ¼å¼ï¼Œå®ƒä¸å…·ä½“çš„ CPU ç±»å‹ã€æ“ä½œç³»ç»Ÿç­‰æ— å…³ï¼Œä»è€Œå¯ä»¥ä¿è¯æ•°æ®åœ¨ä¸åŒä¸»æœºä¹‹é—´ä¼ è¾“æ—¶èƒ½å¤Ÿè¢«æ­£ç¡®è§£é‡Šï¼Œç½‘ç»œå­—èŠ‚é¡ºåºé‡‡ç”¨å¤§ç«¯æ’åºæ–¹å¼ã€‚</p>
<p>BSD Socketæä¾›äº†å°è£…å¥½çš„è½¬æ¢æ¥å£ï¼Œæ–¹ä¾¿ç¨‹åºå‘˜ä½¿ç”¨ã€‚åŒ…æ‹¬ä»ä¸»æœºå­—èŠ‚åºåˆ°ç½‘ç»œå­—èŠ‚åºçš„è½¬æ¢å‡½æ•°ï¼š<code>htons</code>ã€<code>htonl</code>ï¼›ä»ç½‘ç»œå­—èŠ‚åºåˆ°ä¸»æœºå­—èŠ‚åºçš„è½¬æ¢å‡½æ•°ï¼š<code>ntohs</code>ã€<code>ntohl</code>ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="c1">// h   - host ä¸»æœºï¼Œä¸»æœºå­—èŠ‚åº
</span><span class="c1">// to  - è½¬æ¢æˆä»€ä¹ˆ
</span><span class="c1">// n   - network  ç½‘ç»œå­—èŠ‚åº
</span><span class="c1">// s   - short  unsigned short
</span><span class="c1">// l   - long   unsigned in
</span><span class="c1"></span>
<span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="c1">// è½¬æ¢ç«¯å£
</span><span class="c1"></span><span class="kt">uint16_t</span> <span class="nf">htons</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">hostshort</span><span class="p">);</span>     <span class="c1">// ä¸»æœºå­—èŠ‚åº - ç½‘ç»œå­—èŠ‚åº
</span><span class="c1"></span><span class="kt">uint16_t</span> <span class="nf">ntohs</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">netshort</span><span class="p">);</span>      <span class="c1">// ä¸»æœºå­—èŠ‚åº - ç½‘ç»œå­—èŠ‚åº
</span><span class="c1">// è½¬IP
</span><span class="c1"></span><span class="kt">uint32_t</span> <span class="nf">htonl</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">hostlong</span><span class="p">);</span>      <span class="c1">// ä¸»æœºå­—èŠ‚åº - ç½‘ç»œå­—èŠ‚åº
</span><span class="c1"></span><span class="kt">uint32_t</span> <span class="nf">ntohl</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">netlong</span><span class="p">);</span>       <span class="c1">// ä¸»æœºå­—èŠ‚åº - ç½‘ç»œå­—èŠ‚åº
</span></code></pre></td></tr></table>
</div>
</div><h2 id="socketåœ°å€">Socketåœ°å€</h2>
<h3 id="é€šç”¨socketåœ°å€">é€šç”¨Socketåœ°å€</h3>
<p><code>socket </code>ç½‘ç»œç¼–ç¨‹æ¥å£ä¸­è¡¨ç¤º <code>socket </code>åœ°å€çš„æ˜¯ç»“æ„ä½“ <code>sockaddr</code>ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;bits/socket.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="p">{</span>
    <span class="n">sa_family_t</span> <span class="n">sa_family</span><span class="p">;</span>
    <span class="kt">char</span>        <span class="n">sa_data</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
<span class="p">};</span>
<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span> <span class="n">sa_family_t</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><code>sa_family </code>æˆå‘˜æ˜¯åœ°å€æ—ç±»å‹ï¼ˆ<code>sa_family_t</code>ï¼‰çš„å˜é‡ã€‚åœ°å€æ—ç±»å‹é€šå¸¸ä¸åè®®æ—ç±»å‹å¯¹åº”ã€‚å¸¸è§çš„åè®®æ—ï¼ˆ<code>protocol family</code>ï¼Œä¹Ÿç§° <code>domain</code>ï¼‰å’Œå¯¹åº”çš„åœ°å€æ—å…¥ä¸‹æ‰€ç¤º:</p>
<table>
<thead>
<tr>
<th>åè®®æ—</th>
<th>åœ°å€æ—</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>PF_UNIX</td>
<td>AF_UNIX</td>
<td>UNIXæœ¬åœ°åŸŸåè®®æ—</td>
</tr>
<tr>
<td>PF_INET</td>
<td>AF_INET</td>
<td>TCP/IPv4åè®®æ—</td>
</tr>
<tr>
<td>PF_INET6</td>
<td>AF_INET6</td>
<td>TCP/IPv6åè®®æ—</td>
</tr>
</tbody>
</table>
<p>å® <code>PF_* </code>å’Œ <code>AF_*</code> éƒ½å®šä¹‰åœ¨ <code>bits/socket.h </code>å¤´æ–‡ä»¶ä¸­ï¼Œä¸”åè€…ä¸å‰è€…æœ‰å®Œå…¨ç›¸åŒçš„å€¼ï¼Œæ‰€ä»¥äºŒè€…é€šå¸¸æ··ç”¨</p>
<p><code>sa_data </code>æˆå‘˜ç”¨äºå­˜æ”¾ <code>socket </code>åœ°å€å€¼ã€‚ä½†æ˜¯ï¼Œä¸åŒçš„åè®®æ—çš„åœ°å€å€¼å…·æœ‰ä¸åŒçš„å«ä¹‰å’Œé•¿åº¦ï¼Œå¦‚ä¸‹æ‰€ç¤º</p>
<table>
<thead>
<tr>
<th>åè®®æ—</th>
<th>åœ°å€å€¼çš„å«ä¹‰å’Œé•¿åº¦</th>
</tr>
</thead>
<tbody>
<tr>
<td>PF_UNIX</td>
<td>æ–‡ä»¶çš„è·¯å¾„åï¼Œé•¿åº¦å¯ä»¥è¾¾åˆ°108å­—èŠ‚</td>
</tr>
<tr>
<td>PF_INET</td>
<td>16bit ç«¯å£å·å’Œ32bit IPv4 åœ°å€ï¼Œå…±6å­—èŠ‚</td>
</tr>
<tr>
<td>PF_INET6</td>
<td>16bit ç«¯å£å·ï¼Œ32bit æµæ ‡è¯†ï¼Œ128bit IPv6 åœ°å€ï¼Œ32bitèŒƒå›´ID,å…±26å­—èŠ‚</td>
</tr>
</tbody>
</table>
<p>ç”±ä¸Šè¡¨å¯çŸ¥ï¼Œ14 å­—èŠ‚çš„ <code>sa_data </code>æ ¹æœ¬æ— æ³•å®¹çº³å¤šæ•°åè®®æ—çš„åœ°å€å€¼ã€‚å› æ­¤ï¼ŒLinux å®šä¹‰äº†ä¸‹é¢è¿™ä¸ªæ–°çš„é€šç”¨çš„ socket åœ°å€ç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“ä¸ä»…æä¾›äº†è¶³å¤Ÿå¤§çš„ç©ºé—´ç”¨äºå­˜æ”¾åœ°å€å€¼ï¼Œè€Œä¸”æ˜¯å†…å­˜å¯¹é½çš„ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;bits/socket.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="k">struct</span> <span class="n">sockaddr_storage</span>
<span class="p">{</span>
    <span class="n">sa_family_t</span> <span class="n">sa_family</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">__ss_align</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">__ss_padding</span><span class="p">[</span> <span class="mi">128</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__ss_align</span><span class="p">)</span> <span class="p">];</span>
<span class="p">};</span>
<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span> <span class="n">sa_family_t</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="ä¸“ç”¨socketåœ°å€">ä¸“ç”¨Socketåœ°å€</h3>
<p>å¾ˆå¤šç½‘ç»œç¼–ç¨‹å‡½æ•°è¯ç”Ÿæ—©äº IPv4 åè®®ï¼Œé‚£æ—¶å€™éƒ½ä½¿ç”¨çš„æ˜¯ <code>struct sockaddr </code>ç»“æ„ä½“ï¼Œä¸ºäº†å‘å‰å…¼å®¹ï¼Œç°åœ¨sockaddr é€€åŒ–æˆäº†<code>ï¼ˆvoid *ï¼‰</code>çš„ä½œç”¨ï¼Œä¼ é€’ä¸€ä¸ªåœ°å€ç»™å‡½æ•°ï¼Œè‡³äºè¿™ä¸ªå‡½æ•°æ˜¯ <code>sockaddr_in</code> è¿˜æ˜¯<code>sockaddr_in6</code>ï¼Œç”±åœ°å€æ—ç¡®å®šï¼Œç„¶åå‡½æ•°å†…éƒ¨å†å¼ºåˆ¶ç±»å‹è½¬åŒ–ä¸ºæ‰€éœ€çš„åœ°å€ç±»å‹</p>
<img src="https://i0.hdslb.com/bfs/album/96c89b02d535bca9ad4e2f0903da9b264d6dfb6d.png" title="" alt="" data-align="center">
<p>UNIX æœ¬åœ°åŸŸåè®®æ—ä½¿ç”¨å¦‚ä¸‹ä¸“ç”¨çš„ socket åœ°å€ç»“æ„ä½“ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;sys/un.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="k">struct</span> <span class="n">sockaddr_un</span>
<span class="p">{</span>
    <span class="n">sa_family_t</span> <span class="n">sin_family</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">sun_path</span><span class="p">[</span><span class="mi">108</span><span class="p">];</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>TCP/IP åè®®æ—æœ‰ <code>sockaddr_in </code>å’Œ <code>sockaddr_in6 </code>ä¸¤ä¸ªä¸“ç”¨çš„ socket åœ°å€ç»“æ„ä½“ï¼Œå®ƒä»¬åˆ†åˆ«ç”¨äº IPv4 å’Œ IPv6:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;netinet/in.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="k">struct</span> <span class="n">sockaddr_in</span>
<span class="p">{</span>
    <span class="n">sa_family_t</span> <span class="n">sin_family</span><span class="p">;</span>     <span class="cm">/* __SOCKADDR_COMMON(sin_) */</span>
    <span class="n">in_port_t</span> <span class="n">sin_port</span><span class="p">;</span>         <span class="cm">/* Port number.  */</span>
    <span class="k">struct</span> <span class="n">in_addr</span> <span class="n">sin_addr</span><span class="p">;</span>    <span class="cm">/* Internet address.  */</span>
    <span class="cm">/* Pad to size of `struct sockaddr&#39;. */</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sin_zero</span><span class="p">[</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="p">)</span> <span class="o">-</span> <span class="n">__SOCKADDR_COMMON_SIZE</span> <span class="o">-</span>
               <span class="k">sizeof</span> <span class="p">(</span><span class="n">in_port_t</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">in_addr</span><span class="p">)];</span>
<span class="p">};</span>  
<span class="k">struct</span> <span class="n">in_addr</span>
<span class="p">{</span>
    <span class="n">in_addr_t</span> <span class="n">s_addr</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">sockaddr_in6</span>
<span class="p">{</span>
    <span class="n">sa_family_t</span> <span class="n">sin6_family</span><span class="p">;</span>
    <span class="n">in_port_t</span> <span class="n">sin6_port</span><span class="p">;</span>    <span class="cm">/* Transport layer port # */</span>
    <span class="kt">uint32_t</span> <span class="n">sin6_flowinfo</span><span class="p">;</span> <span class="cm">/* IPv6 flow information */</span>
    <span class="k">struct</span> <span class="n">in6_addr</span> <span class="n">sin6_addr</span><span class="p">;</span>  <span class="cm">/* IPv6 address */</span>
    <span class="kt">uint32_t</span> <span class="n">sin6_scope_id</span><span class="p">;</span> <span class="cm">/* IPv6 scope-id */</span>
 <span class="p">};</span>
<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">short</span>  <span class="kt">uint16_t</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span>    <span class="kt">uint32_t</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">uint16_t</span> <span class="n">in_port_t</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">uint32_t</span> <span class="n">in_addr_t</span><span class="p">;</span>
<span class="cp">#define __SOCKADDR_COMMON_SIZE (sizeof (unsigned short int))
</span></code></pre></td></tr></table>
</div>
</div><p>æ‰€æœ‰ä¸“ç”¨ socket åœ°å€ï¼ˆä»¥åŠ <code>sockaddr_storage</code>ï¼‰ç±»å‹çš„å˜é‡åœ¨å®é™…ä½¿ç”¨æ—¶éƒ½éœ€è¦è½¬åŒ–ä¸ºé€šç”¨ socket åœ°å€ç±»å‹ <code>sockaddr</code>ï¼ˆå¼ºåˆ¶è½¬åŒ–å³å¯ï¼‰ï¼Œå› ä¸ºæ‰€æœ‰ socket ç¼–ç¨‹æ¥å£ä½¿ç”¨çš„åœ°å€å‚æ•°ç±»å‹éƒ½æ˜¯ <code>sockaddr</code>ã€‚</p>
<h2 id="ipåœ°å€è½¬æ¢">IPåœ°å€è½¬æ¢</h2>
<p>é€šå¸¸ï¼Œäººä»¬ä¹ æƒ¯ç”¨å¯è¯»æ€§å¥½çš„å­—ç¬¦ä¸²æ¥è¡¨ç¤º IP åœ°å€ï¼Œæ¯”å¦‚ç”¨ç‚¹åˆ†åè¿›åˆ¶å­—ç¬¦ä¸²è¡¨ç¤º IPv4 åœ°å€ï¼Œä»¥åŠç”¨åå…­è¿›åˆ¶å­—ç¬¦ä¸²è¡¨ç¤º IPv6 åœ°å€ã€‚ä½†ç¼–ç¨‹ä¸­æˆ‘ä»¬éœ€è¦å…ˆæŠŠå®ƒä»¬è½¬åŒ–ä¸ºæ•´æ•°ï¼ˆäºŒè¿›åˆ¶æ•°ï¼‰æ–¹èƒ½ä½¿ç”¨ã€‚è€Œè®°å½•æ—¥å¿—æ—¶åˆ™ç›¸åï¼Œæˆ‘ä»¬è¦æŠŠæ•´æ•°è¡¨ç¤ºçš„ IP åœ°å€è½¬åŒ–ä¸ºå¯è¯»çš„å­—ç¬¦ä¸²ã€‚ä¸‹é¢ 3 ä¸ªå‡½æ•°å¯ç”¨äºç”¨ç‚¹åˆ†åè¿›åˆ¶å­—ç¬¦ä¸²è¡¨ç¤ºçš„ IPv4 åœ°å€å’Œç”¨ç½‘ç»œå­—èŠ‚åºæ•´æ•°è¡¨ç¤ºçš„ IPv4 åœ°å€ä¹‹é—´çš„è½¬æ¢ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="n">in_addr_t</span> <span class="nf">inet_addr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">inet_aton</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">in_addr</span> <span class="o">*</span><span class="n">inp</span><span class="p">);</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">inet_ntoa</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_addr</span> <span class="n">in</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸‹é¢è¿™å¯¹æ›´æ–°çš„å‡½æ•°ä¹Ÿèƒ½å®Œæˆå‰é¢ 3 ä¸ªå‡½æ•°åŒæ ·çš„åŠŸèƒ½ï¼Œå¹¶ä¸”å®ƒä»¬åŒæ—¶é€‚ç”¨ IPv4 åœ°å€å’Œ IPv6 åœ°å€ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="c1">// p:ç‚¹åˆ†åè¿›åˆ¶çš„IPå­—ç¬¦ä¸²ï¼Œn:è¡¨ç¤ºnetworkï¼Œç½‘ç»œå­—èŠ‚åºçš„æ•´æ•°
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">inet_pton</span><span class="p">(</span><span class="kt">int</span> <span class="n">af</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dst</span><span class="p">);</span>
    <span class="nl">af</span><span class="p">:</span><span class="err">åœ°å€æ—ï¼š</span> <span class="n">AF_INET</span>  <span class="n">AF_INET6</span>
    <span class="nl">src</span><span class="p">:</span><span class="err">éœ€è¦è½¬æ¢çš„ç‚¹åˆ†åè¿›åˆ¶çš„</span><span class="n">IPå­—ç¬¦ä¸²</span>
    <span class="nl">dst</span><span class="p">:</span><span class="err">è½¬æ¢åçš„ç»“æœä¿å­˜åœ¨è¿™ä¸ªé‡Œé¢</span>
<span class="c1">// å°†ç½‘ç»œå­—èŠ‚åºçš„æ•´æ•°ï¼Œè½¬æ¢æˆç‚¹åˆ†åè¿›åˆ¶çš„IPåœ°å€å­—ç¬¦ä¸²
</span><span class="c1"></span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">inet_ntop</span><span class="p">(</span><span class="kt">int</span> <span class="n">af</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="n">size</span><span class="p">);</span>
    <span class="nl">af</span><span class="p">:</span><span class="err">åœ°å€æ—ï¼š</span> <span class="n">AF_INET</span>  <span class="n">AF_INET6</span>
    <span class="nl">src</span><span class="p">:</span> <span class="err">è¦è½¬æ¢çš„</span><span class="n">ipçš„æ•´æ•°çš„åœ°å€</span>
    <span class="nl">dst</span><span class="p">:</span> <span class="err">è½¬æ¢æˆ</span><span class="n">IPåœ°å€å­—ç¬¦ä¸²ä¿å­˜çš„åœ°æ–¹</span>
    <span class="n">size</span><span class="err">ï¼šç¬¬ä¸‰ä¸ªå‚æ•°çš„å¤§å°ï¼ˆæ•°ç»„çš„å¤§å°ï¼‰</span>
    <span class="err">è¿”å›å€¼ï¼šè¿”å›è½¬æ¢åçš„æ•°æ®çš„åœ°å€ï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼Œå’Œ</span> <span class="n">dst</span> <span class="err">æ˜¯ä¸€æ ·çš„</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="å¥—æ¥å­—å‡½æ•°">å¥—æ¥å­—å‡½æ•°</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;      </span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;  // åŒ…å«äº†è¿™ä¸ªå¤´æ–‡ä»¶ï¼Œä¸Šé¢ä¸¤ä¸ªå°±å¯ä»¥çœç•¥</span><span class="cp">
</span><span class="cp"></span><span class="kt">int</span> <span class="nf">socket</span><span class="p">(</span><span class="kt">int</span> <span class="n">domain</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">);</span>
    <span class="o">-</span> <span class="err">åŠŸèƒ½ï¼šåˆ›å»ºä¸€ä¸ªå¥—æ¥å­—</span>
    <span class="o">-</span> <span class="err">å‚æ•°ï¼š</span>
        <span class="o">-</span> <span class="nl">domain</span><span class="p">:</span> <span class="err">åè®®æ—</span>
            <span class="nl">AF_INET</span> <span class="p">:</span> <span class="n">ipv4</span>
            <span class="nl">AF_INET6</span> <span class="p">:</span> <span class="n">ipv6</span>
            <span class="n">AF_UNIX</span><span class="p">,</span> <span class="nl">AF_LOCAL</span> <span class="p">:</span> <span class="err">æœ¬åœ°å¥—æ¥å­—é€šä¿¡ï¼ˆè¿›ç¨‹é—´é€šä¿¡ï¼‰</span>
        <span class="o">-</span> <span class="nl">type</span><span class="p">:</span> <span class="err">é€šä¿¡è¿‡ç¨‹ä¸­ä½¿ç”¨çš„åè®®ç±»å‹</span>
            <span class="nl">SOCK_STREAM</span> <span class="p">:</span> <span class="err">æµå¼åè®®</span>
            <span class="nl">SOCK_DGRAM</span>  <span class="p">:</span> <span class="err">æŠ¥å¼åè®®</span>
        <span class="o">-</span> <span class="nl">protocol</span> <span class="p">:</span> <span class="err">å…·ä½“çš„ä¸€ä¸ªåè®®ã€‚ä¸€èˆ¬å†™</span><span class="mi">0</span>
            <span class="o">-</span> <span class="nl">SOCK_STREAM</span> <span class="p">:</span> <span class="err">æµå¼åè®®é»˜è®¤ä½¿ç”¨</span> <span class="n">TCP</span>
            <span class="o">-</span> <span class="nl">SOCK_DGRAM</span>  <span class="p">:</span> <span class="err">æŠ¥å¼åè®®é»˜è®¤ä½¿ç”¨</span> <span class="n">UDP</span>
        <span class="o">-</span> <span class="err">è¿”å›å€¼ï¼š</span>
            <span class="o">-</span> <span class="err">æˆåŠŸï¼šè¿”å›æ–‡ä»¶æè¿°ç¬¦ï¼Œæ“ä½œçš„å°±æ˜¯å†…æ ¸ç¼“å†²åŒºã€‚</span>
            <span class="o">-</span> <span class="err">å¤±è´¥ï¼š</span><span class="o">-</span><span class="mi">1</span>         
<span class="kt">int</span> <span class="n">bind</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="n">addrlen</span><span class="p">);</span> <span class="c1">// socketå‘½
</span><span class="c1"></span><span class="err">å</span>
    <span class="o">-</span> <span class="err">åŠŸèƒ½ï¼šç»‘å®šï¼Œå°†</span><span class="n">fd</span> <span class="err">å’Œæœ¬åœ°çš„</span><span class="n">IP</span> <span class="o">+</span> <span class="err">ç«¯å£è¿›è¡Œç»‘å®š</span>
    <span class="o">-</span> <span class="err">å‚æ•°ï¼š</span>
            <span class="o">-</span> <span class="nl">sockfd</span> <span class="p">:</span> <span class="err">é€šè¿‡</span><span class="n">socketå‡½æ•°å¾—åˆ°çš„æ–‡ä»¶æè¿°ç¬¦</span>
            <span class="o">-</span> <span class="nl">addr</span> <span class="p">:</span> <span class="err">éœ€è¦ç»‘å®šçš„</span><span class="n">socketåœ°å€</span><span class="err">ï¼Œè¿™ä¸ªåœ°å€å°è£…äº†</span><span class="n">ipå’Œç«¯å£å·çš„ä¿¡æ¯</span>
            <span class="o">-</span> <span class="nl">addrlen</span> <span class="p">:</span> <span class="err">ç¬¬äºŒä¸ªå‚æ•°ç»“æ„ä½“å çš„å†…å­˜å¤§å°</span>

<span class="kt">int</span> <span class="n">listen</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">backlog</span><span class="p">);</span>    <span class="c1">// /proc/sys/net/core/somaxconn
</span><span class="c1"></span>    <span class="o">-</span> <span class="err">åŠŸèƒ½ï¼šç›‘å¬è¿™ä¸ª</span><span class="n">socketä¸Šçš„è¿æ¥</span>
    <span class="o">-</span> <span class="err">å‚æ•°ï¼š</span>
        <span class="o">-</span> <span class="nl">sockfd</span> <span class="p">:</span> <span class="err">é€šè¿‡</span><span class="n">socket</span><span class="p">()</span><span class="err">å‡½æ•°å¾—åˆ°çš„æ–‡ä»¶æè¿°ç¬¦</span>
        <span class="o">-</span> <span class="nl">backlog</span> <span class="p">:</span> <span class="err">æœªè¿æ¥çš„å’Œå·²ç»è¿æ¥çš„å’Œçš„æœ€å¤§å€¼ï¼Œ</span> <span class="mi">5</span>
<span class="kt">int</span> <span class="n">accept</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="o">*</span><span class="n">addrlen</span><span class="p">);</span>
    <span class="o">-</span> <span class="err">åŠŸèƒ½ï¼šæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ï¼Œé»˜è®¤æ˜¯ä¸€ä¸ªé˜»å¡çš„å‡½æ•°ï¼Œé˜»å¡ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥</span> 
    <span class="o">-</span> <span class="err">å‚æ•°ï¼š</span>
            <span class="o">-</span> <span class="nl">sockfd</span> <span class="p">:</span> <span class="err">ç”¨äºç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦</span>
            <span class="o">-</span> <span class="nl">addr</span> <span class="p">:</span> <span class="err">ä¼ å‡ºå‚æ•°ï¼Œè®°å½•äº†è¿æ¥æˆåŠŸåå®¢æˆ·ç«¯çš„åœ°å€ä¿¡æ¯ï¼ˆ</span><span class="n">ip</span><span class="err">ï¼Œ</span><span class="n">port</span><span class="err">ï¼‰</span>
            <span class="o">-</span> <span class="nl">addrlen</span> <span class="p">:</span> <span class="err">æŒ‡å®šç¬¬äºŒä¸ªå‚æ•°çš„å¯¹åº”çš„å†…å­˜å¤§å°</span>
    <span class="o">-</span> <span class="err">è¿”å›å€¼ï¼š</span>
            <span class="o">-</span> <span class="err">æˆåŠŸ</span> <span class="err">ï¼šç”¨äºé€šä¿¡çš„æ–‡ä»¶æè¿°ç¬¦</span> 
            <span class="o">-</span> <span class="o">-</span><span class="mi">1</span> <span class="err">ï¼š</span> <span class="err">å¤±è´¥</span>

<span class="kt">int</span> <span class="n">connect</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="n">addrlen</span><span class="p">);</span>
    <span class="o">-</span> <span class="err">åŠŸèƒ½ï¼š</span> <span class="err">å®¢æˆ·ç«¯è¿æ¥æœåŠ¡å™¨</span>
    <span class="o">-</span> <span class="err">å‚æ•°ï¼š</span>
            <span class="o">-</span> <span class="nl">sockfd</span> <span class="p">:</span> <span class="err">ç”¨äºé€šä¿¡çš„æ–‡ä»¶æè¿°ç¬¦</span>
            <span class="o">-</span> <span class="nl">addr</span> <span class="p">:</span> <span class="err">å®¢æˆ·ç«¯è¦è¿æ¥çš„æœåŠ¡å™¨çš„åœ°å€ä¿¡æ¯</span>
            <span class="o">-</span> <span class="nl">addrlen</span> <span class="p">:</span> <span class="err">ç¬¬äºŒä¸ªå‚æ•°çš„å†…å­˜å¤§å°</span>
    <span class="o">-</span> <span class="err">è¿”å›å€¼ï¼šæˆåŠŸ</span> <span class="mi">0</span><span class="err">ï¼Œ</span> <span class="err">å¤±è´¥</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">ssize_t</span> <span class="n">write</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">count</span><span class="p">);</span>   <span class="c1">// å†™æ•°æ®
</span><span class="c1"></span><span class="n">ssize_t</span> <span class="nf">read</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">count</span><span class="p">);</span>          <span class="c1">// è¯»æ•°
</span></code></pre></td></tr></table>
</div>
</div><p>ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<h4 id="æœåŠ¡å™¨ç«¯">æœåŠ¡å™¨ç«¯</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>

    <span class="c1">// 1 åˆ›å»ºsocketï¼Œ ç”¨äºç›‘å¬
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">lfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lfd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;socket&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// 2 ç»‘å®šç«¯å£
</span><span class="c1"></span>    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">saddr</span><span class="p">;</span>
    <span class="n">saddr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="c1">// inet_pton(AF_INET, &#34;172.25.93.158&#34;, &amp;sockaddr.sin_addr.s_addr);
</span><span class="c1"></span>    <span class="n">saddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">INADDR_ANY</span><span class="p">;</span>
    <span class="n">saddr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">9999</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">lfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">saddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">saddr</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;bind&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// 3 ç›‘å¬
</span><span class="c1"></span>    <span class="n">ret</span> <span class="o">=</span> <span class="n">listen</span><span class="p">(</span><span class="n">lfd</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;listen&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// 4 æ¥å—è¿æ¥
</span><span class="c1"></span>    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">clientaddr</span><span class="p">;</span>
    <span class="n">socklen_t</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clientaddr</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">cfd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">lfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">clientaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cfd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;accept&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// è¾“å‡ºå®¢æˆ·ç«¯ä¿¡æ¯
</span><span class="c1"></span>    <span class="kt">char</span> <span class="n">clientIP</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="n">inet_ntop</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clientaddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="n">clientIP</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clientIP</span><span class="p">));</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">clientPort</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">clientaddr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;client Ip is %s, client port is %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">clientIP</span><span class="p">,</span> <span class="n">clientPort</span><span class="p">);</span>

    <span class="c1">// 5 é€šä¿¡
</span><span class="c1"></span>    <span class="c1">// è·å–å®¢æˆ·ç«¯æ•°æ®
</span><span class="c1"></span>    <span class="kt">char</span> <span class="n">recvBuf</span><span class="p">[</span><span class="mi">1024</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">cfd</span><span class="p">,</span> <span class="n">recvBuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">recvBuf</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">perror</span><span class="p">(</span><span class="s">&#34;read&#34;</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&#34;receive client data : %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">recvBuf</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&#34;client closed...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// ç»™å®¢æˆ·ç«¯å‘é€æ•°æ®
</span><span class="c1"></span>        <span class="kt">char</span> <span class="n">sendBuf</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;hello I am server&#34;</span><span class="p">;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">cfd</span><span class="p">,</span> <span class="n">sendBuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sendBuf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">perror</span><span class="p">(</span><span class="s">&#34;write&#34;</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 6 å…³é—­è¿æ¥
</span><span class="c1"></span>    <span class="n">close</span><span class="p">(</span><span class="n">cfd</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">lfd</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="å®¢æˆ·ç«¯">å®¢æˆ·ç«¯</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>

    <span class="c1">// 1 åˆ›å»ºå¥—æ¥å­—
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;socket&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// 2 è¿æ¥æœåŠ¡å™¨
</span><span class="c1"></span>    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">serverAddr</span><span class="p">;</span>
    <span class="n">serverAddr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">PF_INET</span><span class="p">;</span>
    <span class="n">inet_pton</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="s">&#34;172.25.93.158&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">serverAddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">);</span>
    <span class="n">serverAddr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">9999</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">serverAddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serverAddr</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;connect&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// 3 é€šä¿¡
</span><span class="c1"></span>
    <span class="kt">char</span> <span class="n">recvBuf</span><span class="p">[</span><span class="mi">1024</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>

        <span class="kt">char</span> <span class="n">sendBuf</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;hello I am client&#34;</span><span class="p">;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">sendBuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sendBuf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">perror</span><span class="p">(</span><span class="s">&#34;write&#34;</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>   
        <span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">recvBuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">recvBuf</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">perror</span><span class="p">(</span><span class="s">&#34;read&#34;</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&#34;receive server data : %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">recvBuf</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&#34;server closed...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 4 å…³é—­è¿æ¥
</span><span class="c1"></span>    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> 
</code></pre></td></tr></table>
</div>
</div><h2 id="tcpé€šä¿¡æµç¨‹">TCPé€šä¿¡æµç¨‹</h2>
<img src="https://i0.hdslb.com/bfs/album/2aa381a09efab3e9551f4d46adc07782dff6f658.png" title="" alt="" data-align="center">
<h3 id="æœåŠ¡å™¨ç«¯-è¢«åŠ¨æ¥å—è¿æ¥çš„è§’è‰²">æœåŠ¡å™¨ç«¯ ï¼ˆè¢«åŠ¨æ¥å—è¿æ¥çš„è§’è‰²ï¼‰</h3>
<ol>
<li>
<p><strong>åˆ›å»º</strong>ä¸€ä¸ªç”¨äºç›‘å¬çš„å¥—æ¥å­—  ï¼ˆç›‘å¬ï¼šç›‘å¬æœ‰å®¢æˆ·ç«¯çš„è¿æ¥ï¼›å¥—æ¥å­—ï¼šè¿™ä¸ªå¥—æ¥å­—å…¶å®å°±æ˜¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦  ï¼‰</p>
</li>
<li>
<p>å°†è¿™ä¸ª<strong>ç›‘å¬æ–‡ä»¶æè¿°ç¬¦</strong>å’Œæœ¬åœ°çš„IPå’Œç«¯å£<strong>ç»‘å®š</strong>ï¼ˆIPå’Œç«¯å£å°±æ˜¯æœåŠ¡å™¨çš„åœ°å€ä¿¡æ¯ï¼‰å®¢æˆ·ç«¯è¿æ¥æœåŠ¡å™¨çš„æ—¶å€™ä½¿ç”¨çš„å°±æ˜¯è¿™ä¸ªIPå’Œç«¯å£</p>
</li>
<li>
<p><strong>è®¾ç½®ç›‘å¬</strong>ï¼Œç›‘å¬çš„fdå¼€å§‹å·¥ä½œ</p>
</li>
<li>
<p>é˜»å¡ç­‰å¾…ï¼Œå½“æœ‰å®¢æˆ·ç«¯å‘èµ·è¿æ¥ï¼Œè§£é™¤é˜»å¡ï¼Œ<strong>æ¥å—</strong>å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œä¼šå¾—åˆ°ä¸€ä¸ªå’Œå®¢æˆ·ç«¯é€šä¿¡çš„å¥—æ¥å­—ï¼ˆfdï¼‰</p>
</li>
<li>
<p><strong>é€šä¿¡</strong>  æ¥æ”¶æ•°æ®ã€å‘é€æ•°æ®</p>
</li>
<li>
<p>é€šä¿¡ç»“æŸï¼Œ<strong>æ–­å¼€</strong></p>
</li>
</ol>
<h3 id="å®¢æˆ·ç«¯-1">å®¢æˆ·ç«¯</h3>
<ol>
<li>
<p><strong>åˆ›å»º</strong>ä¸€ä¸ªç”¨äºé€šä¿¡çš„å¥—æ¥å­—ï¼ˆfdï¼‰</p>
</li>
<li>
<p><strong>è¿æ¥</strong>æœåŠ¡å™¨ï¼Œéœ€è¦æŒ‡å®šè¿æ¥çš„æœåŠ¡å™¨çš„ IP å’Œ ç«¯å£</p>
</li>
<li>
<p>è¿æ¥æˆåŠŸäº†ï¼Œå®¢æˆ·ç«¯å¯ä»¥ç›´æ¥å’ŒæœåŠ¡å™¨<strong>é€šä¿¡</strong></p>
<ul>
<li>
<p>æ¥æ”¶æ•°æ®</p>
</li>
<li>
<p>å‘é€æ•°æ®</p>
</li>
</ul>
</li>
<li>
<p>é€šä¿¡ç»“æŸï¼Œ<strong>æ–­å¼€</strong></p>
</li>
</ol>
<h3 id="å¤šè¿›ç¨‹tcpé€šä¿¡">å¤šè¿›ç¨‹TCPé€šä¿¡</h3>
<h4 id="æœåŠ¡ç«¯">æœåŠ¡ç«¯</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt; </span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;wait.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">void</span> <span class="nf">recyleChild</span><span class="p">(</span><span class="kt">int</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// SIGCHILDä¿¡å·å¤„ç†å‡½æ•°
</span><span class="c1"></span>    <span class="c1">// ç”¨äºå›æ”¶èµ„æº
</span><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">waitpid</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">WNOHANG</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// æ‰€æœ‰å­è¿›ç¨‹éƒ½è¢«å›æ”¶
</span><span class="c1"></span>            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// è¿˜æœ‰å­è¿›ç¨‹
</span><span class="c1"></span>            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&#34;å­è¿›ç¨‹ %d è¢«å›æ”¶äº†</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// æ³¨å†Œä¿¡å·ï¼Œå½“å­è¿›ç¨‹é€€å‡ºæ—¶ï¼Œå›æ”¶èµ„æº
</span><span class="c1"></span>    <span class="k">struct</span> <span class="n">sigaction</span> <span class="n">act</span><span class="p">;</span>
    <span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">act</span><span class="p">.</span><span class="n">sa_mask</span><span class="p">);</span>
    <span class="n">act</span><span class="p">.</span><span class="n">sa_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">act</span><span class="p">.</span><span class="n">sa_handler</span> <span class="o">=</span> <span class="n">recyleChild</span><span class="p">;</span>
    <span class="n">sigaction</span><span class="p">(</span><span class="n">SIGCHLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">act</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="c1">// 1 åˆ›å»ºç›‘å¬socket 
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">lfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lfd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;socket&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// 2 ä¸ºç›‘å¬socketç»‘å®šç«¯å£ bind
</span><span class="c1"></span>    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">server_addr</span><span class="p">;</span> 
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">9999</span><span class="p">);</span>
    <span class="n">inet_pton</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="s">&#34;127.0.0.1&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">lfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;bind&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// 3 å¼€å§‹ç›‘å¬ listen
</span><span class="c1"></span>    <span class="n">ret</span> <span class="o">=</span> <span class="n">listen</span><span class="p">(</span><span class="n">lfd</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;listen&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// 4 å¾ªç¯ç­‰å¾…æ¥å—è¯·æ±‚ accept
</span><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">client_add</span>
<span class="n">r</span><span class="p">;</span>
        <span class="n">socklen_t</span> <span class="n">client_socket_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client_addr</span><span class="p">);</span>
        <span class="c1">// è¿™é‡Œçš„ç¬¬ä¸‰ä¸ªå‚æ•°è¦ä¼ é•¿åº¦çš„æŒ‡é’ˆ
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">cfd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">lfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">client_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_socket_len</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cfd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// è¿™é‡Œä¸ºäº†é¿å…å› ä¸ºacceptè¢«å›æ”¶èµ„æºå‡½æ•°ä¸­æ–­è€Œé€€å‡ºç¨‹åº
</span><span class="c1"></span>            <span class="k">if</span><span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EINTR</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">perror</span><span class="p">(</span><span class="s">&#34;accept&#34;</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;client connected, clientSockedFd: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">cfd</span><span class="p">);</span>

        <span class="c1">// 5 åˆ›å»ºæ–°è¿›ç¨‹
</span><span class="c1"></span>        <span class="n">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 6 æ–°è¿›ç¨‹ä¸å®¢æˆ·socketé€šä¿¡
</span><span class="c1"></span>            <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
            <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// å¾ªç¯ä»å®¢æˆ·ç«¯è¯»å–
</span><span class="c1"></span>                <span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">cfd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">perror</span><span class="p">(</span><span class="s">&#34;read&#34;</span><span class="p">);</span>
                    <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;server read data: %s </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// è¯»å®Œäº†
</span><span class="c1"></span>                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;client closed...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="c1">// å‘å®¢æˆ·ç«¯å†™å…¥
</span><span class="c1"></span>                <span class="n">ret</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">cfd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">perror</span><span class="p">(</span><span class="s">&#34;write&#34;</span><span class="p">);</span>
                    <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">close</span><span class="p">(</span><span class="n">cfd</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// å­è¿›ç¨‹é€€å‡º
</span><span class="c1"></span>        <span class="p">}</span> 

    <span class="p">}</span>
    <span class="c1">// 7 å›æ”¶å­è¿›ç¨‹èµ„æº
</span><span class="c1"></span>
    <span class="c1">// 8 å…³é—­è¿æ¥
</span><span class="c1"></span>    <span class="n">close</span><span class="p">(</span><span class="n">lfd</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="å®¢æˆ·ç«¯-2">å®¢æˆ·ç«¯</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 1 åˆ›å»ºsocket
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">cfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cfd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;socket&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// 2 å»ºç«‹è¿æ¥ connect
</span><span class="c1"></span>    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">server_addr</span><span class="p">;</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">9999</span><span class="p">);</span>
    <span class="n">inet_pton</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="s">&#34;127.0.0.1&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">);</span>
    <span class="c1">// æ³¨æ„è¦ç±»å‹è½¬æ¢
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">cfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;connect&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// 3 é€šä¿¡
</span><span class="c1"></span>    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
        <span class="n">write</span><span class="p">(</span><span class="n">cfd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
        <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">cfd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">perror</span><span class="p">(</span><span class="s">&#34;read&#34;</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&#34;quit&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&#34;client quit... </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&#34;receive server data: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
            <span class="c1">// è¯»å–å®Œäº†æœåŠ¡å™¨æ–­å¼€è¿æ¥
</span><span class="c1"></span>            <span class="n">printf</span><span class="p">(</span><span class="s">&#34;server closed&#34;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 4 å…³é—­è¿æ¥
</span><span class="c1"></span>    <span class="n">close</span><span class="p">(</span><span class="n">cfd</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="å¤šçº¿ç¨‹tcpé€šä¿¡">å¤šçº¿ç¨‹TCPé€šä¿¡</h3>
<h4 id="æœåŠ¡ç«¯-1">æœåŠ¡ç«¯</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="k">struct</span> <span class="n">sockInfo</span>
<span class="p">{</span>
    <span class="c1">// çº¿ç¨‹å·
</span><span class="c1"></span>    <span class="n">pthread_t</span> <span class="n">tid</span><span class="p">;</span>
    <span class="c1">// é€šä¿¡çš„æ–‡ä»¶æè¿°ç¬¦
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">addr</span><span class="p">;</span>

<span class="p">};</span>

<span class="k">struct</span> <span class="n">sockInfo</span> <span class="n">sockinfos</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

<span class="kt">void</span><span class="o">*</span> <span class="nf">work</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">arg</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="c1">// 6 åœ¨æ–°çº¿ç¨‹ä¸­é€šä¿¡
</span><span class="c1"></span>    <span class="k">struct</span> <span class="n">sockInfo</span><span class="o">*</span> <span class="n">pinfo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockInfo</span><span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">cfd</span> <span class="o">=</span> <span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
    <span class="c1">// æ‰“å°å®¢æˆ·ç«¯çš„IPå’Œç«¯å£
</span><span class="c1"></span>    <span class="kt">char</span> <span class="n">clientIp</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="n">inet_ntop</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="n">clientIp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clientIp</span><span class="p">));</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">clientPort</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;client ip is : %s, port is : %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">clientIp</span><span class="p">,</span> <span class="n">clientPort</span><span class="p">);</span>

    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// å¾ªç¯ä»å®¢æˆ·ç«¯è¯»å–
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">cfd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">perror</span><span class="p">(</span><span class="s">&#34;read&#34;</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// æ¥æ”¶åˆ°äº†æ•°æ®
</span><span class="c1"></span>            <span class="n">printf</span><span class="p">(</span><span class="s">&#34;server reveiced data: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// è¯»å®Œäº†ï¼Œå…³é—­è¿æ¥
</span><span class="c1"></span>            <span class="n">printf</span><span class="p">(</span><span class="s">&#34;client closed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// å¾€å®¢æˆ·ç«¯å†™æ•°æ®
</span><span class="c1"></span>        <span class="n">write</span><span class="p">(</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">close</span><span class="p">(</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="p">}</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 1 åˆ›å»ºsocket
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">lfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lfd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;socket&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// 2 ä¸ºsocketç»‘å®šIPç«¯å£ bind
</span><span class="c1"></span>    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">server_addr</span><span class="p">;</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">9999</span><span class="p">);</span>
    <span class="n">inet_pton</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="s">&#34;127.0.0.1&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">lfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;bind&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// 3 å¼€å¯ç›‘å¬ listen
</span><span class="c1"></span>    <span class="n">ret</span> <span class="o">=</span> <span class="n">listen</span><span class="p">(</span><span class="n">lfd</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;listen&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// åˆå§‹åŒ–çº¿ç¨‹æ± 
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sockinfos</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sockinfos</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sockinfos</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sockinfos</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
        <span class="n">sockinfos</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">sockinfos</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 4 å¾ªç¯ç›‘å¬ æ¥å—è¿æ¥ accept
</span><span class="c1"></span>        <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">client_addr</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client_addr</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">cfd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">lfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">client_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cfd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">perror</span><span class="p">(</span><span class="s">&#34;accept&#34;</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// 5 å¼€å¯æ–°çº¿ç¨‹
</span><span class="c1"></span>
        <span class="c1">// å¯»æ‰¾å¯ç”¨çº¿ç¨‹
</span><span class="c1"></span>        <span class="k">struct</span> <span class="n">sockInfo</span> <span class="o">*</span><span class="n">pinfo</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sockinfos</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pinfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sockinfos</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// çº¿ç¨‹æ± æ»¡
</span><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
                    <span class="o">--</span><span class="n">i</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">// è®°å½•å®¢æˆ·ç«¯æ–‡ä»¶æè¿°ç¬¦
</span><span class="c1"></span>        <span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="n">cfd</span><span class="p">;</span>
        <span class="c1">// è®°å½•å®¢æˆ·ç«¯åœ°å€ä¿¡æ¯
</span><span class="c1"></span>        <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client_addr</span><span class="p">));</span>
        <span class="c1">// åˆ›å»ºçº¿ç¨‹
</span><span class="c1"></span>        <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">pinfo</span><span class="p">);</span>

        <span class="c1">// åˆ†ç¦»çº¿ç¨‹
</span><span class="c1"></span>        <span class="n">pthread_detach</span><span class="p">(</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>

    <span class="p">}</span>

    <span class="c1">// 7 å…³é—­
</span><span class="c1"></span>    <span class="n">close</span><span class="p">(</span><span class="n">lfd</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="udpé€šä¿¡æµç¨‹">UDPé€šä¿¡æµç¨‹</h2>
<img src="https://i0.hdslb.com/bfs/album/92a4b797fd76a5bf3d65d976dfe969bb5e019e0e.png" title="" alt="" data-align="center">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="n">ssize_t</span> <span class="nf">sendto</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
                      <span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">dest_addr</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="n">addrlen</span><span class="p">);</span>
        <span class="o">-</span> <span class="err">å‚æ•°ï¼š</span>
            <span class="o">-</span> <span class="nl">sockfd</span> <span class="p">:</span> <span class="err">é€šä¿¡çš„</span><span class="n">fd</span>
            <span class="o">-</span> <span class="nl">buf</span> <span class="p">:</span> <span class="err">è¦å‘é€çš„æ•°æ®</span>
            <span class="o">-</span> <span class="nl">len</span> <span class="p">:</span> <span class="err">å‘é€æ•°æ®çš„é•¿åº¦</span>
            <span class="o">-</span> <span class="nl">flags</span> <span class="p">:</span> <span class="mi">0</span>
            <span class="o">-</span> <span class="nl">dest_addr</span> <span class="p">:</span> <span class="err">é€šä¿¡çš„å¦å¤–ä¸€ç«¯çš„åœ°å€ä¿¡æ¯</span>
            <span class="o">-</span> <span class="nl">addrlen</span> <span class="p">:</span> <span class="err">åœ°å€çš„å†…å­˜å¤§å°</span>

<span class="n">ssize_t</span> <span class="n">recvfrom</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
                        <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">src_addr</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="o">*</span><span class="n">addrlen</span><span class="p">);</span>
        <span class="o">-</span> <span class="err">å‚æ•°ï¼š</span>
            <span class="o">-</span> <span class="nl">sockfd</span> <span class="p">:</span> <span class="err">é€šä¿¡çš„</span><span class="n">fd</span>
            <span class="o">-</span> <span class="nl">buf</span> <span class="p">:</span> <span class="err">æ¥æ”¶æ•°æ®çš„æ•°ç»„</span>
            <span class="o">-</span> <span class="nl">len</span> <span class="p">:</span> <span class="err">æ•°ç»„çš„å¤§å°</span> 
            <span class="o">-</span> <span class="nl">flags</span> <span class="p">:</span> <span class="mi">0</span>
            <span class="o">-</span> <span class="nl">src_addr</span> <span class="p">:</span> <span class="err">ç”¨æ¥ä¿å­˜å¦å¤–ä¸€ç«¯çš„åœ°å€ä¿¡æ¯ï¼Œä¸éœ€è¦å¯ä»¥æŒ‡å®šä¸º</span><span class="nb">NULL</span>
            <span class="o">-</span> <span class="nl">addrlen</span> <span class="p">:</span> <span class="err">åœ°å€çš„å†…å­˜å¤§</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="æœåŠ¡ç«¯-2">æœåŠ¡ç«¯</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">// 1.åˆ›å»ºä¸€ä¸ªé€šä¿¡çš„socket
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_DGRAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;socket&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>   

    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">addr</span><span class="p">;</span>
    <span class="n">addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">9999</span><span class="p">);</span>
    <span class="n">addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">INADDR_ANY</span><span class="p">;</span>

    <span class="c1">// 2.ç»‘å®š
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;bind&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// 3.é€šä¿¡
</span><span class="c1"></span>    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">recvbuf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
        <span class="kt">char</span> <span class="n">ipbuf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

        <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">cliaddr</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cliaddr</span><span class="p">);</span>

        <span class="c1">// æ¥æ”¶æ•°æ®
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">recvfrom</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">recvbuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">recvbuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cliaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;client IP : %s, Port : %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> 
            <span class="n">inet_ntop</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cliaddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="n">ipbuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ipbuf</span><span class="p">)),</span>
            <span class="n">ntohs</span><span class="p">(</span><span class="n">cliaddr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;client say : %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">recvbuf</span><span class="p">);</span>

        <span class="c1">// å‘é€æ•°æ®
</span><span class="c1"></span>        <span class="n">sendto</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">recvbuf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">recvbuf</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cliaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cliaddr</span><span class="p">));</span>

    <span class="p">}</span>

    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="å®¢æˆ·ç«¯-3">å®¢æˆ·ç«¯</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">// 1.åˆ›å»ºä¸€ä¸ªé€šä¿¡çš„socket
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_DGRAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;socket&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>   

    <span class="c1">// æœåŠ¡å™¨çš„åœ°å€ä¿¡æ¯
</span><span class="c1"></span>    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">saddr</span><span class="p">;</span>
    <span class="n">saddr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">saddr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">9999</span><span class="p">);</span>
    <span class="n">inet_pton</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="s">&#34;127.0.0.1&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// 3.é€šä¿¡
</span><span class="c1"></span>    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// å‘é€æ•°æ®
</span><span class="c1"></span>        <span class="kt">char</span> <span class="n">sendBuf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">sendBuf</span><span class="p">,</span> <span class="s">&#34;hello , i am client %d </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">num</span><span class="o">++</span><span class="p">);</span>
        <span class="n">sendto</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">sendBuf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sendBuf</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">saddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">saddr</span><span class="p">));</span>

        <span class="c1">// æ¥æ”¶æ•°æ®
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">recvfrom</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">sendBuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sendBuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;server say : %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">sendBuf</span><span class="p">);</span>

        <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<p><a href="http://www.codebaoku.com/it-c/it-c-230866.html" target="_blank" rel="noopener noreffer">SocketåŸç†è¯¦è§£ - ç¼–ç¨‹å®åº“ (codebaoku.com)</a></p></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>æ›´æ–°äº 2021-04-17</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/unix_socket/index.md" target="_blank">é˜…è¯»åŸå§‹æ–‡æ¡£</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="åˆ†äº«åˆ° Twitter" data-sharer="twitter" data-url="https://example.com/unix_socket/" data-title="Unixå¥—æ¥å­—ç¼–ç¨‹" data-hashtags="Unix,Socket"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° å¾®åš" data-sharer="weibo" data-url="https://example.com/unix_socket/" data-title="Unixå¥—æ¥å­—ç¼–ç¨‹" data-image="https://i0.hdslb.com/bfs/album/df7b6d46621859c99357ddcadc6d21f5a3495eba.png" data-ralateuid="xxxx"><i class="fab fa-weibo fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/unix/">Unix</a>,&nbsp;<a href="/tags/socket/">Socket</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">è¿”å›</a></span>&nbsp;|&nbsp;<span><a href="/">ä¸»é¡µ</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/cmake_tutorial/" class="prev" rel="prev" title="CMakeä½¿ç”¨æ–¹æ³•"><i class="fas fa-angle-left fa-fw"></i>CMakeä½¿ç”¨æ–¹æ³•</a>
            <a href="/io_multiplexing/" class="next" rel="next" title="IOå¤šè·¯å¤ç”¨">IOå¤šè·¯å¤ç”¨<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">ç”± <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.91.2">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Weiyee</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="å›åˆ°é¡¶éƒ¨">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="æŸ¥çœ‹è¯„è®º">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.8/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"å¤åˆ¶åˆ°å‰ªè´´æ¿","maxShownLines":30},"comment":{},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"æ²¡æœ‰æ‰¾åˆ°ç»“æœ","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
